import streamlit as st
import pandas as pd
import numpy as np
import plotly.express as px
import plotly.graph_objects as go
from experiment_analysis import ExperimentAnalysis
import seaborn as sns
import io
import base64

# Set page configuration
st.set_page_config(
    page_title="AAÂõûÊ∫ØÂàÜÊûêÂ∑•ÂÖ∑",
    layout="wide",
    initial_sidebar_state="expanded",
    page_icon="üî¨"
)

# Custom CSS for styling
st.markdown("""
    <style>
    /* Main font and colors */
    .main {
        font-family: Arial, sans-serif;
        color: #2C3E50;
    }
    
    /* Headers styling */
    h1 {
        color: #1E88E5;
        font-size: 2.5rem;
        font-weight: 600;
        margin-bottom: 2rem;
    }
    h2 {
        color: #2196F3;
        font-size: 1.8rem;
        font-weight: 500;
        margin-top: 1.5rem;
    }
    h3 {
        color: #42A5F5;
        font-size: 1.3rem;
        font-weight: 500;
    }
    
    /* Button styling */
    .stButton>button {
        background-color: #1E88E5;
        color: white;
        border-radius: 6px;
        padding: 0.5rem 1rem;
        font-weight: 500;
        border: none;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        width: 100%;
        margin: 0.5rem 0;
    }
    .stButton>button:hover {
        background-color: #1976D2;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        transform: translateY(-1px);
    }
    
    /* Action button styling */
    .action-button {
        background-color: #4CAF50 !important;
    }
    .action-button:hover {
        background-color: #388E3C !important;
    }
    
    /* Input fields styling */
    .stTextInput>div>div>input {
        font-family: Arial, sans-serif;
        border-radius: 6px;
        border: 1px solid #E0E0E0;
    }
    
    /* Sidebar styling */
    .css-1d391kg {
        padding: 2rem 1rem;
    }
    
    /* DataFrame styling */
    .dataframe {
        border: 1px solid #E0E0E0;
        border-radius: 6px;
        padding: 1rem;
        width: 100%;
    }
    
    /* Success/Warning/Error messages */
    .stSuccess {
        background-color: #E8F5E9;
        padding: 1rem;
        border-radius: 6px;
        border-left: 4px solid #4CAF50;
        margin: 1rem 0;
    }
    .stWarning {
        background-color: #FFF3E0;
        padding: 1rem;
        border-radius: 6px;
        border-left: 4px solid #FF9800;
        margin: 1rem 0;
    }
    .stError {
        background-color: #FFEBEE;
        padding: 1rem;
        border-radius: 6px;
        border-left: 4px solid #F44336;
        margin: 1rem 0;
    }
    
    /* Card-like containers */
    div.stDataFrame, div.stPlotlyChart {
        background-color: white;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        margin: 1rem 0;
    }
    
    /* Progress indicators */
    .stProgress {
        margin: 1rem 0;
    }
    .stProgress > div > div > div {
        background-color: #1E88E5;
        height: 8px;
        border-radius: 4px;
    }
    
    /* Section connectors */
    .section-connector {
        width: 2px;
        height: 30px;
        background-color: #E0E0E0;
        margin: 0 auto;
    }
    
    /* Step indicators */
    .step-complete {
        color: #4CAF50;
        font-weight: bold;
    }
    .step-current {
        color: #1E88E5;
        font-weight: bold;
    }
    .step-pending {
        color: #9E9E9E;
    }
    
    /* Expander styling */
    .streamlit-expanderHeader {
        font-size: 1.2rem;
        font-weight: 500;
        background-color: #F5F5F5;
        border-radius: 6px;
    }
    
    /* Step indicator badges */
    .step-badge {
        display: inline-block;
        width: 24px;
        height: 24px;
        line-height: 24px;
        text-align: center;
        border-radius: 50%;
        margin-right: 8px;
        font-weight: bold;
        font-size: 14px;
    }
    .step-badge-current {
        background-color: #1E88E5;
        color: white;
    }
    .step-badge-complete {
        background-color: #4CAF50;
        color: white;
    }
    .step-badge-pending {
        background-color: #E0E0E0;
        color: #9E9E9E;
    }
    
    /* Help tooltip */
    .tooltip {
        position: relative;
        display: inline-block;
        cursor: help;
    }
    .tooltip:hover::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        padding: 8px;
        background-color: #333;
        color: white;
        border-radius: 4px;
        font-size: 12px;
        white-space: nowrap;
        z-index: 1000;
    }
    
    /* Section status indicator */
    .section-status {
        float: right;
        font-size: 0.9rem;
        padding: 4px 8px;
        border-radius: 4px;
        margin-left: 8px;
    }
    .status-complete {
        background-color: #E8F5E9;
        color: #4CAF50;
    }
    .status-current {
        background-color: #E3F2FD;
        color: #1E88E5;
    }
    .status-pending {
        background-color: #F5F5F5;
        color: #9E9E9E;
    }
    
    /* Step title styling */
    .step-title {
        font-size: 1.8rem;
        font-weight: 600;
        color: #1E88E5;
        margin: 1rem 0;
        padding: 0.5rem;
        border-radius: 8px;
        background: #E3F2FD;
    }
    
    .step-title.active {
        background: #1E88E5;
        color: white;
    }
    
    .step-title.completed {
        background: #E8F5E9;
        color: #4CAF50;
    }
    </style>
    """, unsafe_allow_html=True)

# Initialize session state
if 'data' not in st.session_state:
    st.session_state.data = None
if 'groups_configured' not in st.session_state:
    st.session_state.groups_configured = False
if 'analyzer' not in st.session_state:
    st.session_state.analyzer = ExperimentAnalysis()
if 'proportions' not in st.session_state:
    st.session_state.proportions = None
if 'show_group_config' not in st.session_state:
    st.session_state.show_group_config = False
if 'show_metric_analysis' not in st.session_state:
    st.session_state.show_metric_analysis = False
if 'show_results' not in st.session_state:
    st.session_state.show_results = False
if 'uploaded_file' not in st.session_state:
    st.session_state.uploaded_file = None
if 'metrics' not in st.session_state:
    st.session_state.metrics = None
if 'metric_types' not in st.session_state:
    st.session_state.metric_types = None
if 'results' not in st.session_state:
    st.session_state.results = None
if 'unit_id_col' not in st.session_state:
    st.session_state.unit_id_col = None
if 'has_preexisting_groups' not in st.session_state:
    st.session_state.has_preexisting_groups = False
if 'group_column' not in st.session_state:
    st.session_state.group_column = None

def reset_analysis():
    """Reset all session state variables to restart analysis"""
    # Clear all session state variables completely
    for key in list(st.session_state.keys()):
        del st.session_state[key]
    
    # Force reinitialization of all variables to their default states
    st.session_state.data = None
    st.session_state.groups_configured = False
    st.session_state.analyzer = ExperimentAnalysis()
    st.session_state.proportions = None
    st.session_state.show_group_config = False
    st.session_state.show_metric_analysis = False
    st.session_state.show_results = False
    st.session_state.uploaded_file = None
    st.session_state.metrics = None
    st.session_state.metric_types = None
    st.session_state.results = None
    st.session_state.unit_id_col = None
    st.session_state.has_preexisting_groups = False
    st.session_state.group_column = None
    
    # Clear any widget states
    if 'seed_input' in st.session_state:
        del st.session_state.seed_input
    if 'groups_input' in st.session_state:
        del st.session_state.groups_input
    
    # Force the UI to show only the data upload section
    st.session_state.show_group_config = False
    st.session_state.show_metric_analysis = False
    st.session_state.show_results = False

def get_download_link(df, filename, text):
    """Generate a download link for a DataFrame"""
    output = io.BytesIO()
    with pd.ExcelWriter(output, engine='openpyxl') as writer:
        df.to_excel(writer, index=False, sheet_name='Sheet1')
    excel_data = output.getvalue()
    b64 = base64.b64encode(excel_data).decode()
    href = f'<a href="data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,{b64}" download="{filename}">{text}</a>'
    return href

def plot_group_distribution(data, group_column):
    """Create a bar plot for group distribution"""
    group_counts = data[group_column].value_counts()
    fig = px.bar(
        x=group_counts.index,
        y=group_counts.values,
        title="Group Distribution",
        labels={'x': 'Group', 'y': 'Count'},
        color=group_counts.index
    )
    return fig

def plot_metric_boxplot(data, metric, group_column):
    """Create a box plot for metric distribution by group"""
    fig = px.box(
        data,
        x=group_column,
        y=metric,
        title=f"{metric} Distribution by Group",
        color=group_column
    )
    return fig

# Calculate progress
progress = 0
if st.session_state.data is not None:
    progress += 25
if st.session_state.groups_configured:
    progress += 25
if st.session_state.show_metric_analysis:
    progress += 25
if st.session_state.show_results:
    progress += 25

# Page title and reset button
st.markdown("""
<div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 0;">
    <div>
        <h1 style="margin: 0;">üî¨ AAÂõûÊ∫ØÂàÜÊûêÂ∑•ÂÖ∑</h1>
        <p style="font-size: 1.2rem; color: #666; margin: 0;">‰∏Ä‰∏™ÂÖ®Èù¢ÁöÑÂú®Á∫øÂÆûÈ™åÂàÜÊûêÂ∑•ÂÖ∑</p>
    </div>
</div>
""", unsafe_allow_html=True)

# Show progress bar
st.progress(progress/100)
st.markdown(f"<p style='text-align: center; color: #666;'>ÂàÜÊûêËøõÂ∫¶: {progress}%</p>", unsafe_allow_html=True)

# Sidebar with information
with st.sidebar:
    st.image("https://raw.githubusercontent.com/streamlit/streamlit/develop/examples/streamlit_app_logo.png", width=200)
    st.markdown("---")
    
    # Add statistical test direction selection
    st.markdown("### üìä ÁªüËÆ°Ê£ÄÈ™åËÆæÁΩÆ")
    test_direction = st.radio(
        "ÈÄâÊã©Ê£ÄÈ™åÊñπÂêë",
        options=[
            "ÂèåËæπÊ£ÄÈ™å (Two-sided)",
            "ÂçïËæπÊ£ÄÈ™å-‰∏äÂçá (One-sided, Greater)",
            "ÂçïËæπÊ£ÄÈ™å-‰∏ãÈôç (One-sided, Less)"
        ],
        help="""
        - ÂèåËæπÊ£ÄÈ™åÔºöÊ£ÄÈ™åÂÆûÈ™åÁªÑ‰∏éÂØπÁÖßÁªÑÊòØÂê¶ÊúâÊòæËëóÂ∑ÆÂºÇÔºà‰∏äÂçáÊàñ‰∏ãÈôçÔºâ
        - ÂçïËæπÊ£ÄÈ™å-‰∏äÂçáÔºöÊ£ÄÈ™åÂÆûÈ™åÁªÑÊòØÂê¶ÊòæËëóÈ´ò‰∫éÂØπÁÖßÁªÑ
        - ÂçïËæπÊ£ÄÈ™å-‰∏ãÈôçÔºöÊ£ÄÈ™åÂÆûÈ™åÁªÑÊòØÂê¶ÊòæËëó‰Ωé‰∫éÂØπÁÖßÁªÑ
        """
    )
    
    # Convert selection to parameters for statistical test
    is_two_sided = test_direction == "ÂèåËæπÊ£ÄÈ™å (Two-sided)"
    alternative = "two-sided"
    if not is_two_sided:
        alternative = "greater" if "‰∏äÂçá" in test_direction else "less"
    
    st.markdown("---")
    
    # Add experiment information section
    st.markdown("### üìä ÂÆûÈ™å‰ø°ÊÅØ")
    if st.session_state.data is not None:
        st.info(f"""
        - Êï∞ÊçÆÈõÜÂ§ßÂ∞è: {st.session_state.data.shape[0]} Ë°å
        - ÂÆûÈ™åÂçïÂÖÉ: {st.session_state.unit_id_col}
        - ÊåáÊ†áÊï∞Èáè: {len(st.session_state.data.select_dtypes(include=[np.number]).columns)}
        """)
    else:
        st.info("ËØ∑‰∏ä‰º†Êï∞ÊçÆÈõÜÂºÄÂßãÂàÜÊûê")
    
    st.markdown("---")
    
    # Add progress tracking
    st.markdown("### üéØ ÂàÜÊûêËøõÂ∫¶")
    progress_status = []
    if st.session_state.data is not None:
        progress_status.append("‚úÖ Êï∞ÊçÆ‰∏ä‰º†ÂÆåÊàê")
    if st.session_state.groups_configured:
        progress_status.append("‚úÖ ÂàÜÁªÑÈÖçÁΩÆÂÆåÊàê")
    if st.session_state.show_metric_analysis:
        progress_status.append("‚úÖ ÊåáÊ†áÂàÜÊûêÂÆåÊàê")
    
    if progress_status:
        for status in progress_status:
            st.write(status)
    else:
        st.write("‚è≥ Á≠âÂæÖÂºÄÂßãÂàÜÊûê...")
    
    st.markdown("---")
    
    # Add help information
    st.markdown("### ‚ÑπÔ∏è Â∏ÆÂä©‰ø°ÊÅØ")
    with st.expander("‰ΩøÁî®ËØ¥Êòé"):
        st.markdown("""
        1. **Êï∞ÊçÆ‰∏ä‰º†**
           - ÊîØÊåÅCSVÂíåExcelÊ†ºÂºè
           - ÈúÄË¶ÅÂåÖÂê´ÂîØ‰∏ÄÊ†áËØÜÂàó
        
        2. **ÂàÜÁªÑÈÖçÁΩÆ**
           - ËÆæÁΩÆÂØπÁÖßÁªÑÊØî‰æã
           - ÈÖçÁΩÆÂÆûÈ™åÁªÑÊï∞Èáè
        
        3. **ÊåáÊ†áÂàÜÊûê**
           - ÊîØÊåÅÂùáÂÄº„ÄÅÊØî‰æã„ÄÅÊØîÁéáÂàÜÊûê
           - Ëá™Âä®ËÆ°ÁÆóÁªüËÆ°ÊòæËëóÊÄß
        """)
    
    with st.expander("ÂÖ≥‰∫é"):
        st.markdown("""
        ÂÆûÈ™åÂàÜÊûêÂ∑•ÂÖ∑ v1.0
        
        - ÊîØÊåÅÂ§öÁßçÁªüËÆ°Ê£ÄÈ™åÊñπÊ≥ï
        - Ëá™Âä®ÁîüÊàêÂàÜÊûêÊä•Âëä
        - Êï∞ÊçÆÂèØËßÜÂåñÂ±ïÁ§∫
        """)

# Main content area
st.markdown("---")

# Helper function for step badges
def get_step_badge(step_number, status):
    return f"""
    <span class="step-badge step-badge-{status}">{step_number}</span>
    """

# Helper function for section status
def get_section_status(status, text):
    return f"""
    <span class="section-status status-{status}">{text}</span>
    """

# Section 1: Data Upload
with st.expander("Á¨¨‰∏ÄÊ≠•ÔºöÊï∞ÊçÆ‰∏ä‰º†", expanded=not st.session_state.show_group_config):
    status = "completed" if st.session_state.data is not None else "active"
    st.markdown(f"""
    <div class='step-title {status}'>
    üì§ Á¨¨‰∏ÄÊ≠•ÔºöÊï∞ÊçÆ‰∏ä‰º†
    </div>
    """, unsafe_allow_html=True)
    
    uploaded_file = st.file_uploader("‰∏ä‰º†Êï∞ÊçÆÈõÜÔºàÊîØÊåÅCSVÊàñExcelÊ†ºÂºèÔºâ", type=['csv', 'xlsx', 'xls'])
    
    if uploaded_file is not None:
        try:
            # Read the file
            if uploaded_file.name.endswith('.csv'):
                data = pd.read_csv(uploaded_file)
            else:
                data = pd.read_excel(uploaded_file)
            
            unit_id_col = st.selectbox(
                "ÈÄâÊã©ÂåÖÂê´ÂÆûÈ™åÂçïÂÖÉIDÁöÑÂàóÔºö",
                options=data.columns.tolist(),
                help="ÈÄâÊã©ÂåÖÂê´ÂÆûÈ™åÂçïÂÖÉÂîØ‰∏ÄÊ†áËØÜÁ¨¶ÁöÑÂàó"
            )

            # Ê£ÄÊü•ÊòØÂê¶Â≠òÂú®È¢ÑÂàÜÁªÑ
            potential_group_columns = []
            
            # 1. Ê£ÄÊü•ÂàóÂêç‰∏≠ÂåÖÂê´'group'ÁöÑÂàó
            columns_with_group_name = [col for col in data.columns if 'group' in col.lower()]
            potential_group_columns.extend(columns_with_group_name)
            
            # 2. Ê£ÄÊü•Â≠óÁ¨¶‰∏≤Á±ªÂûãÂàóÁöÑÂÜÖÂÆπÊòØÂê¶ÂåÖÂê´'group'
            string_columns = data.select_dtypes(include=['object']).columns
            for col in string_columns:
                if col not in potential_group_columns:  # ÈÅøÂÖçÈáçÂ§çÊ£ÄÊü•
                    # Ê£ÄÊü•Ââç100Ë°åÊï∞ÊçÆ
                    sample_values = data[col].head(100).astype(str).str.lower()
                    if any(sample_values.str.contains('group')):
                        potential_group_columns.append(col)
            
            # ÂéªÈáç
            potential_group_columns = list(set(potential_group_columns))
            
            if potential_group_columns:
                st.info(f"Ê£ÄÊµãÂà∞‰ª•‰∏ãÂèØËÉΩÁöÑÂàÜÁªÑÂàóÔºö\n" + 
                       "\n".join([f"- {col}" for col in potential_group_columns]) +
                       "\nÊÇ®ÂèØ‰ª•ÈÄâÊã©‰ΩøÁî®Â∑≤ÊúâÁöÑÂàÜÁªÑÊàñÈáçÊñ∞ÂàÜÁªÑ„ÄÇ")
                
                use_existing_groups = st.checkbox("‰ΩøÁî®Â∑≤ÊúâÂàÜÁªÑ", value=True)
                
                if use_existing_groups:
                    # ÊòæÁ§∫ÊØè‰∏™ÊΩúÂú®ÂàÜÁªÑÂàóÁöÑÂîØ‰∏ÄÂÄºÁ§∫‰æã
                    st.write("ÂêÑÂàÜÁªÑÂàóÁöÑÂîØ‰∏ÄÂÄºÁ§∫‰æãÔºö")
                    for col in potential_group_columns:
                        unique_values = data[col].unique()
                        st.write(f"**{col}**: {', '.join(map(str, unique_values[:5]))}" + 
                               ("..." if len(unique_values) > 5 else ""))
                    
                    group_column = st.selectbox(
                        "ÈÄâÊã©ÂàÜÁªÑÂàóÔºö",
                        options=potential_group_columns,
                        help="ÈÄâÊã©ÂåÖÂê´ÂÆûÈ™åÁªÑ‰ø°ÊÅØÁöÑÂàó"
                    )
                    st.session_state.has_preexisting_groups = True
                    st.session_state.group_column = group_column
            else:
                st.session_state.has_preexisting_groups = False
                st.session_state.group_column = None
            
            if st.button("Â§ÑÁêÜÊï∞ÊçÆÈõÜ"):
                try:
                    # Process unit IDs
                    data[unit_id_col] = data[unit_id_col].apply(
                        lambda x: '{:.0f}'.format(float(x)) if pd.notnull(x) else '')
                    
                    if unit_id_col != 'apollo_key':
                        data['apollo_key'] = data[unit_id_col]
                    
                    # Â¶ÇÊûú‰ΩøÁî®È¢ÑÂàÜÁªÑÔºåÈáçÂëΩÂêçÂàÜÁªÑÂàóÂπ∂Ë∑≥ËøáÂàÜÁªÑÈÖçÁΩÆ
                    if st.session_state.has_preexisting_groups:
                        data['group_name'] = data[st.session_state.group_column]
                        st.session_state.groups_configured = True
                        st.session_state.show_metric_analysis = True
                        
                        # ÊòæÁ§∫Áé∞ÊúâÂàÜÁªÑÁöÑÂàÜÂ∏ÉÊÉÖÂÜµ
                        group_counts = data['group_name'].value_counts()
                        total_samples = len(data)
                        actual_proportions = (group_counts / total_samples * 100).round(2)
                        
                        st.success("‚úÖ ‰ΩøÁî®Â∑≤ÊúâÂàÜÁªÑËøõË°åÂàÜÊûêÔºÅ")
                        st.write("Áé∞ÊúâÂàÜÁªÑÂàÜÂ∏ÉÔºö")
                        
                        # ÂàõÂª∫ÊØîËæÉDataFrame
                        distribution_df = pd.DataFrame({
                            'Ê†∑Êú¨Êï∞': group_counts,
                            'ÊØî‰æã(%)': actual_proportions
                        }).round(2)
                        st.dataframe(distribution_df)
                        
                        # ÊòæÁ§∫ÂàÜÁªÑÂàÜÂ∏ÉÂõæË°®
                        col1, col2 = st.columns(2)
                        with col1:
                            st.subheader("Ê†∑Êú¨Êï∞ÈáèÂàÜÂ∏É")
                            fig_counts = px.bar(
                                distribution_df,
                                y='Ê†∑Êú¨Êï∞',
                                title='ÂêÑÁªÑÊ†∑Êú¨Êï∞Èáè',
                                color=distribution_df.index,
                                text='Ê†∑Êú¨Êï∞'
                            )
                            fig_counts.update_traces(textposition='outside')
                            fig_counts.update_layout(
                                showlegend=False,
                                height=400,
                                yaxis_title="Ê†∑Êú¨Êï∞Èáè",
                                xaxis_title="ÂÆûÈ™åÁªÑ"
                            )
                            st.plotly_chart(fig_counts, use_container_width=True)
                        
                        with col2:
                            st.subheader("ÂàÜÁªÑÊØî‰æãÂàÜÂ∏É")
                            fig_props = px.bar(
                                distribution_df,
                                y='ÊØî‰æã(%)',
                                title='ÂêÑÁªÑÊØî‰æãÂàÜÂ∏É',
                                color=distribution_df.index,
                                text='ÊØî‰æã(%)'
                            )
                            fig_props.update_traces(textposition='outside')
                            fig_props.update_layout(
                                showlegend=False,
                                height=400,
                                yaxis_title="ÊØî‰æã (%)",
                                xaxis_title="ÂÆûÈ™åÁªÑ",
                                yaxis=dict(range=[0, 100])
                            )
                            st.plotly_chart(fig_props, use_container_width=True)
                    else:
                        st.session_state.show_group_config = True
                    
                    st.session_state.data = data
                    st.session_state.unit_id_col = unit_id_col
                    
                    # Show complete processed dataframe
                    st.subheader("üìã Â§ÑÁêÜÂêéÁöÑÊï∞ÊçÆÈõÜ")
                    st.dataframe(data)
                    
                    # Show detailed information in tabs
                    st.subheader("üìä Êï∞ÊçÆÈõÜËØ¶ÊÉÖ")
                    summary_tab, stats_tab = st.tabs(["Êï∞ÊçÆÊ¶ÇËßà", "ÁªüËÆ°‰ø°ÊÅØ"])
                    
                    with summary_tab:
                        col1, col2 = st.columns(2)
                        with col1:
                            st.write("Êï∞ÊçÆÈõÜ‰ø°ÊÅØÔºö")
                            st.write(f"- Ë°åÊï∞Ôºö{data.shape[0]}")
                            st.write(f"- ÂàóÊï∞Ôºö{data.shape[1]}")
                            st.write("ÂÆûÈ™åÂçïÂÖÉIDÁ§∫‰æãÔºö", data['apollo_key'].head().tolist())
                        
                        with col2:
                            st.write("Êï∞ÊçÆÁ±ªÂûãÔºö")
                            st.write(data.dtypes)
                    
                    with stats_tab:
                        numeric_cols = data.select_dtypes(include=[np.number]).columns
                        if not numeric_cols.empty:
                            st.write("Êï∞ÂÄºÂàóÁªüËÆ°‰ø°ÊÅØÔºö")
                            st.dataframe(data[numeric_cols].describe())
                    
                except Exception as e:
                    st.error(f"Â§ÑÁêÜÂÆûÈ™åÂçïÂÖÉIDÊó∂Âá∫ÈîôÔºö{str(e)}")
                    st.error("Â¶ÇÊûúÈÅáÂà∞ÈóÆÈ¢òÔºåËØ∑ÁÇπÂáªÂè≥‰∏äËßíÁöÑ'üîÑ ÈáçÊñ∞ÂºÄÂßã'ÊåâÈíÆÈáçÁΩÆÂ∫îÁî®„ÄÇ")
            
        except Exception as e:
            st.error(f"ËØªÂèñÊñá‰ª∂Êó∂Âá∫ÈîôÔºö{str(e)}")
            st.error("Â¶ÇÊûúÈÅáÂà∞ÈóÆÈ¢òÔºåËØ∑ÁÇπÂáªÂè≥‰∏äËßíÁöÑ'üîÑ ÈáçÊñ∞ÂºÄÂßã'ÊåâÈíÆÈáçÁΩÆÂ∫îÁî®„ÄÇ")

# Visual connector
if st.session_state.show_group_config:
    st.markdown("<div class='section-connector'></div>", unsafe_allow_html=True)

# Section 2: Group Configuration
if st.session_state.show_group_config:
    with st.expander("Á¨¨‰∫åÊ≠•ÔºöÂàÜÁªÑÈÖçÁΩÆ", expanded=True):
        status = "completed" if st.session_state.groups_configured else "active"
        st.markdown(f"""
        <div class='step-title {status}'>
        ‚öôÔ∏è Á¨¨‰∫åÊ≠•ÔºöÂàÜÁªÑÈÖçÁΩÆ
        </div>
        """, unsafe_allow_html=True)
        
        # Add tooltips to inputs
        st.markdown("""
        <div class="tooltip" data-tooltip="‰∏∫ÊÇ®ÁöÑÂÆûÈ™åËÆæÁΩÆ‰∏Ä‰∏™ÂîØ‰∏ÄÊ†áËØÜÁ¨¶">
        ÈöèÊú∫ÁßçÂ≠ê
        </div>
        """, unsafe_allow_html=True)
        random_seed = st.text_input("", value="experiment_1", key="seed_input")
        
        st.markdown("""
        <div class="tooltip" data-tooltip="ËÆæÁΩÆÈúÄË¶ÅÊµãËØïÁöÑ‰∏çÂêåÂ§ÑÁêÜÁªÑÊï∞Èáè">
        Â§ÑÁêÜÁªÑÊï∞Èáè
        </div>
        """, unsafe_allow_html=True)
        n_groups = st.number_input("", min_value=1, max_value=5, value=1, key="groups_input")
        
        # Group proportion inputs
        proportions = {}
        col1, col2 = st.columns(2)
        
        with col1:
            control_prop = st.slider("ÂØπÁÖßÁªÑÂç†ÊØî %", 1, 100, 50)
            proportions["control_group"] = control_prop
        
        remaining_prop = 100 - control_prop
        
        with col2:
            if n_groups == 1:
                proportions["treatment_group_1"] = remaining_prop
                st.write(f"Â§ÑÁêÜÁªÑÂç†ÊØîÔºö{remaining_prop}%")
            else:
                default_treatment_prop = remaining_prop // n_groups
                remaining_for_treatments = remaining_prop
                for i in range(n_groups):
                    if i < n_groups - 1:
                        prop = st.slider(f"Â§ÑÁêÜÁªÑ {i+1} Âç†ÊØî %", 1, remaining_for_treatments, default_treatment_prop)
                        proportions[f"treatment_group_{i+1}"] = prop
                        remaining_for_treatments -= prop
                    else:
                        proportions[f"treatment_group_{i+1}"] = remaining_for_treatments
                        st.write(f"Â§ÑÁêÜÁªÑ {i+1} Âç†ÊØîÔºö{remaining_for_treatments}%")
        
        # È™åËØÅÊÄªÊØî‰æãÊòØÂê¶‰∏∫100%
        total_proportion = sum(proportions.values())
        if total_proportion != 100:
            st.error(f"ÊâÄÊúâÁªÑÁöÑÊÄªÂç†ÊØîÂøÖÈ°ªÁ≠â‰∫é100%ÔºåÂΩìÂâçÊÄªÂç†ÊØî‰∏∫{total_proportion}%")
        else:
            if st.button("ÁîüÊàêÂàÜÁªÑ"):
                try:
                    progress_bar = st.progress(0)
                    status_text = st.empty()
                    
                    status_text.text("ÂàùÂßãÂåñÂàÜÁªÑÁºñÂè∑...")
                    st.session_state.data['bucket_number'] = st.session_state.data['apollo_key'].apply(
                        lambda x: st.session_state.analyzer.apollo_bucket(random_seed, x))
                    progress_bar.progress(25)
                    
                    status_text.text("ÂàÜÈÖçÂÆûÈ™åÁªÑ...")
                    proportions_with_percent = {k: f"{v}%" for k, v in proportions.items()}
                    st.session_state.data['group_name'] = st.session_state.data['bucket_number'].apply(
                        lambda x: st.session_state.analyzer.assign_groups(x, proportions_with_percent))
                    progress_bar.progress(50)
                    
                    status_text.text("È™åËØÅÂàÜÁªÑÁªìÊûú...")
                    group_counts = st.session_state.data['group_name'].value_counts()
                    total_samples = len(st.session_state.data)
                    
                    # ËÆ°ÁÆóÂÆûÈôÖÊØî‰æã
                    actual_proportions = (group_counts / total_samples * 100).round(2)
                    
                    # ÂàõÂª∫ÊØîËæÉDataFrame
                    comparison_df = pd.DataFrame({
                        'ÁõÆÊ†áÊØî‰æã': proportions,
                        'ÂÆûÈôÖÊØî‰æã': actual_proportions,
                        'Ê†∑Êú¨Êï∞': group_counts
                    }).round(2)
                    
                    progress_bar.progress(75)
                    
                    status_text.text("ÂÆåÊàêÂàÜÁªÑÈÖçÁΩÆ...")
                    st.session_state.groups_configured = True
                    st.session_state.proportions = proportions_with_percent
                    progress_bar.progress(100)
                    status_text.text("ÂàÜÁªÑÁîüÊàêÂÆåÊàêÔºÅ")
                    
                    st.success("‚úÖ ÂàÜÁªÑÁîüÊàêÊàêÂäüÔºÅ")
                    
                    # ÊòæÁ§∫ÂàÜÁªÑÂàÜÂ∏ÉÊØîËæÉ
                    st.write("ÂàÜÁªÑÂàÜÂ∏ÉÊØîËæÉÔºö")
                    st.dataframe(comparison_df)
                    
                    # ÂàõÂª∫‰∏§‰∏™ÂàóÊù•ÊîæÁΩÆÂõæË°®
                    col1, col2 = st.columns(2)
                    
                    # Ê†∑Êú¨Êï∞ÈáèÊü±Áä∂Âõæ
                    with col1:
                        st.subheader("Ê†∑Êú¨Êï∞ÈáèÂàÜÂ∏É")
                        fig_counts = px.bar(
                            comparison_df,
                            y='Ê†∑Êú¨Êï∞',
                            title='ÂêÑÁªÑÊ†∑Êú¨Êï∞Èáè',
                            labels={'index': 'ÁªÑÂà´', 'value': 'Ê†∑Êú¨Êï∞'},
                            color=comparison_df.index,
                            text='Ê†∑Êú¨Êï∞'  # ÊòæÁ§∫ÂÖ∑‰ΩìÊï∞ÂÄº
                        )
                        fig_counts.update_traces(textposition='outside')  # Â∞ÜÊï∞ÂÄºÊòæÁ§∫Âú®Êü±Â≠ê‰∏äÊñπ
                        fig_counts.update_layout(
                            showlegend=False,
                            height=400,
                            yaxis_title="Ê†∑Êú¨Êï∞Èáè",
                            xaxis_title="ÂÆûÈ™åÁªÑ"
                        )
                        st.plotly_chart(fig_counts, use_container_width=True)
                    
                    # ÊØî‰æãÂØπÊØîÊü±Áä∂Âõæ
                    with col2:
                        st.subheader("ÂàÜÁªÑÊØî‰æãÂØπÊØî")
                        fig_props = go.Figure()
                        
                        # Ê∑ªÂä†ÁõÆÊ†áÊØî‰æãÊü±Áä∂Âõæ
                        fig_props.add_trace(go.Bar(
                            name='ÁõÆÊ†áÊØî‰æã',
                            x=comparison_df.index,
                            y=comparison_df['ÁõÆÊ†áÊØî‰æã'],
                            text=comparison_df['ÁõÆÊ†áÊØî‰æã'].apply(lambda x: f'{x:.1f}%'),
                            textposition='outside'
                        ))
                        
                        # Ê∑ªÂä†ÂÆûÈôÖÊØî‰æãÊü±Áä∂Âõæ
                        fig_props.add_trace(go.Bar(
                            name='ÂÆûÈôÖÊØî‰æã',
                            x=comparison_df.index,
                            y=comparison_df['ÂÆûÈôÖÊØî‰æã'],
                            text=comparison_df['ÂÆûÈôÖÊØî‰æã'].apply(lambda x: f'{x:.1f}%'),
                            textposition='outside'
                        ))
                        
                        # Êõ¥Êñ∞Â∏ÉÂ±Ä
                        fig_props.update_layout(
                            title='ÁõÆÊ†áÊØî‰æã vs ÂÆûÈôÖÊØî‰æã',
                            height=400,
                            yaxis_title="ÊØî‰æã (%)",
                            xaxis_title="ÂÆûÈ™åÁªÑ",
                            barmode='group',
                            yaxis=dict(range=[0, 100])  # Âõ∫ÂÆöyËΩ¥ËåÉÂõ¥‰∏∫0-100%
                        )
                        st.plotly_chart(fig_props, use_container_width=True)
                    
                    st.markdown("### üì• ‰∏ãËΩΩÂ§ÑÁêÜÂêéÁöÑÊï∞ÊçÆÈõÜ")
                    st.markdown("‰∏ãËΩΩÂåÖÂê´ÂàÜÁªÑ‰ø°ÊÅØÁöÑÊï∞ÊçÆÈõÜÔºö")
                    st.markdown(get_download_link(
                        st.session_state.data,
                        "processed_dataset_with_groups.xlsx",
                        "üì• ‰∏ãËΩΩÂàÜÁªÑÂêéÁöÑÊï∞ÊçÆÈõÜ"
                    ), unsafe_allow_html=True)
                    
                    st.session_state.show_metric_analysis = True
                    
                except Exception as e:
                    st.error(f"ÂàÜÁªÑÈÖçÁΩÆÂá∫ÈîôÔºö{str(e)}")

# Visual connector
if st.session_state.show_metric_analysis:
    st.markdown("<div class='section-connector'></div>", unsafe_allow_html=True)

# Section 3: Metric Analysis
if st.session_state.show_metric_analysis:
    with st.expander("Á¨¨‰∏âÊ≠•ÔºöÊåáÊ†áÂàÜÊûê", expanded=st.session_state.show_metric_analysis and not st.session_state.show_results):
        status = "completed" if st.session_state.show_results else "active"
        st.markdown(f"""
        <div class='step-title {status}'>
        üìä Á¨¨‰∏âÊ≠•ÔºöÊåáÊ†áÂàÜÊûê
        </div>
        """, unsafe_allow_html=True)
        
        st.markdown("""
        <div style="margin-bottom: 1rem;">
        <b>ÊåáÊ†áÁ±ªÂûãËØ¥ÊòéÔºö</b>
        <ul>
        <li><b>ÂùáÂÄº</b>ÔºöÊØîËæÉÂπ≥ÂùáÂÄºÔºàÂ¶ÇÔºöÊî∂ÂÖ•„ÄÅ‰ΩøÁî®Êó∂ÈïøÔºâ</li>
        <li><b>ÊØî‰æã</b>ÔºöÊØîËæÉÊØîÁéáÊàñÁôæÂàÜÊØîÔºàÂ¶ÇÔºöËΩ¨ÂåñÁéáÔºâ</li>
        <li><b>ÊØîÂÄº</b>ÔºöÊØîËæÉ‰∏§‰∏™ÊåáÊ†áÁöÑÊØîÂÄºÔºàÂ¶ÇÔºö‰∫∫ÂùáÊî∂ÂÖ•Ôºâ</li>
        </ul>
        </div>
        """, unsafe_allow_html=True)
        
        numeric_cols = st.session_state.data.select_dtypes(include=[np.number]).columns.tolist()
        if 'bucket_number' in numeric_cols:
            numeric_cols.remove('bucket_number')
        
        metrics = st.multiselect("ÈÄâÊã©ÈúÄË¶ÅÂàÜÊûêÁöÑÊåáÊ†áÔºö", numeric_cols)
        
        if metrics:
            metric_types = []
            cols = st.columns(len(metrics))
            for i, metric in enumerate(metrics):
                with cols[i]:
                    metric_type = st.selectbox(
                        f"{metric} ÁöÑÊåáÊ†áÁ±ªÂûã",
                        ["ÂùáÂÄº", "ÊØî‰æã", "ÊØîÂÄº"],
                        key=f"metric_type_{i}"
                    )
                    metric_types.append(metric_type.replace("ÂùáÂÄº", "mean").replace("ÊØî‰æã", "proportion").replace("ÊØîÂÄº", "ratio"))
            
            if st.button("ËøêË°åÂàÜÊûê"):
                try:
                    progress_bar = st.progress(0)
                    status_text = st.empty()
                    
                    status_text.text("ÂáÜÂ§áÊï∞ÊçÆÂàÜÊûê...")
                    
                    # Â§ÑÁêÜÈ¢ÑÂàÜÁªÑÊï∞ÊçÆÁöÑÊÉÖÂÜµ
                    if st.session_state.has_preexisting_groups:
                        # Ëé∑ÂèñÊâÄÊúâÈùûÂØπÁÖßÁªÑÁöÑÁªÑÂêç
                        all_groups = st.session_state.data['group_name'].unique()
                        control_group = [g for g in all_groups if 'control' in g.lower()]
                        if not control_group:  # Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞ÂåÖÂê´'control'ÁöÑÁªÑÂêçÔºå‰ΩøÁî®Á¨¨‰∏Ä‰∏™ÁªÑ‰Ωú‰∏∫ÂØπÁÖßÁªÑ
                            control_group = [all_groups[0]]
                        treatment_groups = [g for g in all_groups if g not in control_group]
                        control_label = control_group[0]
                        treated_labels = treatment_groups
                    else:
                        # ‰ΩøÁî®ÂéüÊúâÁöÑÂàÜÁªÑÈÄªËæë
                        n_treatment_groups = len(st.session_state.proportions) - 1
                        control_label = "control_group"
                        treated_labels = [f"treatment_group_{i+1}" for i in range(n_treatment_groups)]
                    
                    progress_bar.progress(25)
                    
                    status_text.text("ÊâßË°åÁªüËÆ°Ê£ÄÈ™å...")
                    results = st.session_state.analyzer.run_statistical_tests(
                        data=st.session_state.data,
                        metrics=metrics,
                        metric_types=metric_types,
                        groupname="group_name",
                        treated_labels=treated_labels,
                        control_label=control_label,
                        is_two_sided=is_two_sided,
                        alternative=alternative
                    )
                    progress_bar.progress(75)
                    
                    status_text.text("ÁîüÊàêÂàÜÊûêÁªìÊûú...")
                    st.session_state.results = results
                    progress_bar.progress(100)
                    status_text.text("ÂàÜÊûêÂÆåÊàêÔºÅ")
                    
                    st.success("‚úÖ ÂàÜÊûêÂÆåÊàêÔºÅ")
                    
                    st.write("ÂàÜÊûêÁªìÊûúÔºö")
                    st.dataframe(results)
                    
                    st.markdown("### üì• ‰∏ãËΩΩÂàÜÊûêÁªìÊûú")
                    st.markdown(get_download_link(
                        results,
                        "experiment_results.xlsx",
                        "üì• ‰∏ãËΩΩÂàÜÊûêÁªìÊûúÊä•Âëä"
                    ), unsafe_allow_html=True)
                    
                except Exception as e:
                    st.error(f"ÂàÜÊûêËøáÁ®ãÂá∫ÈîôÔºö{str(e)}")
                    st.error("ÈîôËØØËØ¶ÁªÜ‰ø°ÊÅØÔºö")
                    st.write("Áé∞ÊúâÂàÜÁªÑÔºö", st.session_state.data['group_name'].unique())
                    st.write("ÊåáÊ†áÔºö", metrics)
                    st.write("ÊåáÊ†áÁ±ªÂûãÔºö", metric_types)

# Remove the entire Section 4: Results Summary section and its related code
if st.session_state.show_results:
    st.markdown("<div class='section-connector'></div>", unsafe_allow_html=True) 